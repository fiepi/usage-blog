<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.6.2">Jekyll</generator><link href="https://blog.fiepi.com/atom.xml" rel="self" type="application/atom+xml" /><link href="https://blog.fiepi.com/" rel="alternate" type="text/html" /><updated>2017-11-06T13:10:58+08:00</updated><id>https://blog.fiepi.com/</id><title type="html">玛修·基列莱特</title><subtitle>先輩最低です</subtitle><author><name>Mash Kyrielight</name><email>fiepi.dev@gamil.com</email></author><entry><title type="html">ss-redir+iptables+ipset+dnsmasq 配置记录</title><link href="https://blog.fiepi.com/archlinux/ss-redir_iptables_ipset_dnsmasq.html" rel="alternate" type="text/html" title="ss-redir+iptables+ipset+dnsmasq 配置记录" /><published>2017-11-05T00:00:00+08:00</published><updated>2017-11-05T00:00:00+08:00</updated><id>https://blog.fiepi.com/archlinux/ss-redir_iptables_ipset_dnsmasq</id><content type="html" xml:base="https://blog.fiepi.com/archlinux/ss-redir_iptables_ipset_dnsmasq.html">&lt;p&gt;记录 ss-redir 透明代理配置过程。
&lt;!-- more --&gt;&lt;/p&gt;

&lt;h2 id=&quot;-相关软件包&quot;&gt;# 相关软件包&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;pacman &lt;span class=&quot;nt&quot;&gt;-S&lt;/span&gt; dnsmasq ipset shadowsocks-libev&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;-ss-redir-配置&quot;&gt;# ss-redir 配置&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# 创建配置文件&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vim /etc/shadowsocks/ss-redir.json&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-json&quot; data-lang=&quot;json&quot;&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
	&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;server&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;[server_ip]&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
	&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;server_port&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;server_port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
	&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;local_port&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10800&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
	&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;local_address&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
	&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;password&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;password&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
	&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;timeout&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;300&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
	&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;method&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;aes-256-gcm&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# systemd 守护进程&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vim /etc/systemd/system/ss-redir.service&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-conf&quot; data-lang=&quot;conf&quot;&gt;[&lt;span class=&quot;n&quot;&gt;Unit&lt;/span&gt;]
&lt;span class=&quot;n&quot;&gt;Description&lt;/span&gt;=&lt;span class=&quot;n&quot;&gt;Shadowsocks&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Libev&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Client&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Service&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Redir&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mode&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;After&lt;/span&gt;=&lt;span class=&quot;n&quot;&gt;network&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;target&lt;/span&gt;

[&lt;span class=&quot;n&quot;&gt;Service&lt;/span&gt;]
&lt;span class=&quot;n&quot;&gt;Type&lt;/span&gt;=&lt;span class=&quot;n&quot;&gt;simple&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;User&lt;/span&gt;=&lt;span class=&quot;n&quot;&gt;nobody&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;CapabilityBoundingSet&lt;/span&gt;=&lt;span class=&quot;n&quot;&gt;CAP_NET_ADMIN&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CAP_NET_BIND_SERVICE&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ExecStart&lt;/span&gt;=/&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;bin&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;ss&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;redir&lt;/span&gt; -&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;etc&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;shadowsocks&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;ss&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;redir&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;json&lt;/span&gt; -&lt;span class=&quot;n&quot;&gt;u&lt;/span&gt;

[&lt;span class=&quot;n&quot;&gt;Install&lt;/span&gt;]
&lt;span class=&quot;n&quot;&gt;WantedBy&lt;/span&gt;=&lt;span class=&quot;n&quot;&gt;multi&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;target&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# 保持自启动&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl start ss-redir.service
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;ss-redir.service&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;-iptables--ipset-实现-chnroute-分流&quot;&gt;# iptables + ipset 实现 chnroute 分流&lt;/h2&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# 获取中国 IP&lt;/span&gt;
su
wget &lt;span class=&quot;nt&quot;&gt;-O-&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest'&lt;/span&gt; | awk &lt;span class=&quot;nt&quot;&gt;-F&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\|&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'/CN\|ipv4/ { printf(&quot;%s/%d\n&quot;, $4, 32-log($5)/log(2)) }'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /etc/chnroute.txt
&lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# 停用默认防火墙自启动服务&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl disable iptables.service
&lt;span class=&quot;c&quot;&gt;# 新建启动脚本&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vim /etc/iptables/ss-up.sh&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;

ipset &lt;span class=&quot;nt&quot;&gt;-N&lt;/span&gt; chnroute &lt;span class=&quot;nb&quot;&gt;hash&lt;/span&gt;:net maxelem 65536

&lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;ip &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'/etc/chnroute.txt'&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do
  &lt;/span&gt;ipset add chnroute &lt;span class=&quot;nv&quot;&gt;$ip&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;done

&lt;/span&gt;iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-N&lt;/span&gt; SHADOWSOCKS

&lt;span class=&quot;c&quot;&gt;# 直连服务器 IP&lt;/span&gt;
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; SHADOWSOCKS &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;server_ip]/24 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN

&lt;span class=&quot;c&quot;&gt;# 允许连接保留地址&lt;/span&gt;
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; SHADOWSOCKS &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 0.0.0.0/8 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; SHADOWSOCKS &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 10.0.0.0/8 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; SHADOWSOCKS &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 127.0.0.0/8 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; SHADOWSOCKS &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 169.254.0.0/16 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; SHADOWSOCKS &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 172.16.0.0/12 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; SHADOWSOCKS &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 192.168.0.0/16 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; SHADOWSOCKS &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 224.0.0.0/4 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; SHADOWSOCKS &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 240.0.0.0/4 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN

&lt;span class=&quot;c&quot;&gt;# 直连中国 IP&lt;/span&gt;
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; SHADOWSOCKS &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--match-set&lt;/span&gt; chnroute dst &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; SHADOWSOCKS &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; icmp &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--match-set&lt;/span&gt; chnroute dst &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN

&lt;span class=&quot;c&quot;&gt;# 重定向到 ss-redir 端口&lt;/span&gt;
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; SHADOWSOCKS &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; REDIRECT &lt;span class=&quot;nt&quot;&gt;--to-port&lt;/span&gt; 10800
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; SHADOWSOCKS &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; udp &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; REDIRECT &lt;span class=&quot;nt&quot;&gt;--to-port&lt;/span&gt; 10800
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; OUTPUT &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; SHADOWSOCKS&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;#测试执行情况&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;chmod +x /etc/iptables/ss-up.sh
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;sh /etc/iptables/ss-up.sh&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# 创建停止脚本&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vim /etc/iptables/ss-down.sh
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;chmod +x /etc/iptables/ss-down.sh&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-D&lt;/span&gt; OUTPUT &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; icmp &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; SHADOWSOCKS
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-D&lt;/span&gt; OUTPUT &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; SHADOWSOCKS
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-F&lt;/span&gt; SHADOWSOCKS
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-X&lt;/span&gt; SHADOWSOCKS
ipset destroy chnroute&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# 复制修改原 iptables 的 systemd 配置&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;cp /usr/lib/systemd/system/iptables.service /etc/systemd/system/iptables-proxy.service
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vim /etc/systemd/system/iptables-proxy.service&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-conf&quot; data-lang=&quot;conf&quot;&gt;[&lt;span class=&quot;n&quot;&gt;Unit&lt;/span&gt;]
&lt;span class=&quot;n&quot;&gt;Description&lt;/span&gt;=&lt;span class=&quot;n&quot;&gt;Packet&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Filtering&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Framework&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Shadowsocks&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;chnroute&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;Before&lt;/span&gt;=&lt;span class=&quot;n&quot;&gt;network&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;pre&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;target&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;Wants&lt;/span&gt;=&lt;span class=&quot;n&quot;&gt;network&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;pre&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;target&lt;/span&gt;

[&lt;span class=&quot;n&quot;&gt;Service&lt;/span&gt;]
&lt;span class=&quot;n&quot;&gt;Type&lt;/span&gt;=&lt;span class=&quot;n&quot;&gt;oneshot&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ExecStart&lt;/span&gt;=/&lt;span class=&quot;n&quot;&gt;etc&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;iptables&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;ss&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;up&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;sh&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ExecStop&lt;/span&gt;=/&lt;span class=&quot;n&quot;&gt;etc&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;iptables&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;ss&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;down&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;sh&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;RemainAfterExit&lt;/span&gt;=&lt;span class=&quot;n&quot;&gt;yes&lt;/span&gt;

[&lt;span class=&quot;n&quot;&gt;Install&lt;/span&gt;]
&lt;span class=&quot;n&quot;&gt;WantedBy&lt;/span&gt;=&lt;span class=&quot;n&quot;&gt;multi&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;target&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;#检查并添加自启动&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl daemon-reload
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl start iptables-proxy.service
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl status iptables-proxy.service
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;iptables-proxy.service&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;-dnsmasq-的配置&quot;&gt;# dnsmasq 的配置&lt;/h2&gt;
&lt;p&gt;Dnsmasq 提供 DNS 缓存和 DHCP 服务功能，通过缓存 DNS 请求来提高对访问过的网址的连接速度。&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vim /etc/dnsmasq.conf&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-conf&quot; data-lang=&quot;conf&quot;&gt;&lt;span class=&quot;c&quot;&gt;# 去掉这几行的注释
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resolv&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;=/&lt;span class=&quot;n&quot;&gt;etc&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;resolv&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;dnsmasq&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;conf&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;listen&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;address&lt;/span&gt;=&lt;span class=&quot;m&quot;&gt;127&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# 修改 Dnsmasq DNS&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vim /etc/resolv.dnsmasq.conf &lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-conf&quot; data-lang=&quot;conf&quot;&gt;&lt;span class=&quot;n&quot;&gt;nameserver&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;nameserver&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;8&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# 修改系统 DNS&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vim /etc/resolv.conf&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-conf&quot; data-lang=&quot;conf&quot;&gt;&lt;span class=&quot;n&quot;&gt;nameserver&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;127&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;#防止被修改&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;chattr +i /etc/resolv.conf&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;更多细节： &lt;a href=&quot;https://wiki.archlinux.org/index.php/dnsmasq&quot;&gt; Dnsmasq - Arch Wiki&lt;/a&gt;&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;# 启动 Dnsmasq &lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl start dnsmasq.service
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl status dnsmasq.service
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;dnsmasq.service
&lt;span class=&quot;c&quot;&gt;# 重启系统看看各项功能是否正常&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;reboot&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;</content><author><name>fiepi</name></author><category term="archlinux" /><category term="ss-redir" /><category term="iptables" /><category term="archlinux" /><category term="ipset" /><category term="dnsmasq" /><summary type="html">记录 ss-redir 透明代理配置过程。</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://i.loli.net/2017/11/05/59ff0dc66ede7.jpg" /></entry><entry><title type="html">记录 archlinux 下 aria2+https 的配置过程</title><link href="https://blog.fiepi.com/archlinux/aria2_config.html" rel="alternate" type="text/html" title="记录 archlinux 下 aria2+https 的配置过程" /><published>2017-11-04T00:00:00+08:00</published><updated>2017-11-04T00:00:00+08:00</updated><id>https://blog.fiepi.com/archlinux/aria2_config</id><content type="html" xml:base="https://blog.fiepi.com/archlinux/aria2_config.html">&lt;p&gt;Aria2 是一个轻量的多协议、多线程下载器。这里记录一下安装配置过程。&lt;/p&gt;

&lt;!-- more --&gt;

&lt;h1 id=&quot;1-安装&quot;&gt;1. 安装&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;sudo pacman -S aria2 certbot nginx&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;2-配置&quot;&gt;2. 配置&lt;/h1&gt;

&lt;p&gt;假设下载服务器域名为：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;aria2.fiepi.com
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;1-配置临时-web-服务器获取免费-lets-encrypt-证书&quot;&gt;（1） 配置临时 web 服务器获取免费 Let’s Encrypt 证书&lt;/h2&gt;

&lt;p&gt;添加&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;include vhost/*.conf;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;到&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;/etc/nginx/nginx.conf&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;创建 nginx 配置文件&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;sudo mkdir /etc/nginx/vhost&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;sudo vim /etc/nginx/vhost/aria2.fiepi.com.conf&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;server {
    listen 80;
    server_name aria2.fiepi.com;
    index index.html index.htm;
    root /home/fiepi/web/root;
    autoindex on;
    autoindex_exact_size off;
    autoindex_localtime on;
    location / {
    }
    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|flv|ico)$ {
        expires 30d;
        access_log off;
    }
    location ~ .*\.(js|css)?$ {
        expires 7d;
        access_log off;
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;测试配置无误后重启 nginx 并生成证书&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo nginx -t

sudo systemctl restart nginx.service

sudo certbot certonly --webroot -w /home/fiepi/web/root -d aria2.fiepi.com

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;证书路径：&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;/etc/letsencrypt/archive/aria2.fiepi.com/&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;修改权限让 aria2 能够读取&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;sudo chown -R fiepi:users /etc/letsencrypt/archive&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;移除临时 web 配置&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;sudo mv /etc/nginx/vhost/aria2.fiepi.com.conf /etc/nginx/vhost/aria2.fiepi.com.conf.bak&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;sudo systemctl restart nginx.service&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;2创建-aria2-配置&quot;&gt;（2）创建 aria2 配置&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;mkdir -p ~/.config/aria2&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;vim ~/.config/aria2/aria2.conf&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;随机生成身份认证的 Token：&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;openssl rand -hex 15&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;## 下载路径
dir=~/Downloads/aria2
## 生成随机 Token: openssl rand -hex 15
rpc-secret=xxxxxx
rpc-secure=true
## 证书
rpc-certificate=/etc/letsencrypt/archive/aria2.fiepi.com/fullchain1.pem
rpc-private-key=/etc/letsencrypt/archive/aria2.fiepi.com/privkey1.pem
## http代理
# http-proxy=http://127.0.0.1:8118
## 上传速度限制 0 为不限制
max-overall-upload-limit=10K
max-upload-limit=2K
## 是否预先分配磁盘空间
file-allocation=prealloc
## 是否继续下载未完成的文件
continue=true
## 日志级别，可以为debug, info, notice, warn 或 error
log-level=info
## 每下载任务最大连接数
max-connection-per-server=10
## 下载进度输出的间隔时间
#summary-interval=120
## 是否以进程的方式启动
daemon=true
## 是否启用rpc
enable-rpc=true
## rpc监听端口
rpc-listen-port=6800
## 是否在所有网卡上启用监听
rpc-listen-all=true
## 最大同时下载任务数，根据实际情况修改
#max-concurrent-downloads=3
## 会话保存文件，进程退出时保存未下载完成的会话
save-session=/home/fiepi/.config/aria2/session.lock
## 启动输入文件，进程启动时读取上次未下载完成的会话
input-file=/home/fiepi/.config/aria2/session.lock
## 日志文件，根据实际情况修改
#log=~/.config/aria2/aria.log
## 是否关闭ipv6
disable-ipv6=true
## 磁盘缓存
disk-cache=0
## 超时时间
#timeout=600
## 重试等待时间
#retry-wait=30
## 最大重试次数，0代表可以无限次重试
#max-tries=0
## user agent，此处所填值用于伪装成百度云网盘客户端
user-agent=netdisk;4.4.0.6;PC;PC-Windows;6.2.9200 WindowsBaiduYunGuanJia
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;3创建-systemd-守护进程&quot;&gt;（3）创建 systemd 守护进程&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;sudo vim /etc/systemd/user/aria2.service&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[Unit]
Description=Aria2 Service
After=network.target

[Service]
Type=forking
WorkingDirectory=%h
ExecStart=/usr/bin/aria2c --daemon --enable-rpc --rpc-listen-all --rpc-allow-origin-all -c -D  --conf-path=%h/.config/aria2/aria2.conf

[Install]
WantedBy=default.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;启动&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl --user start aria2.service

systemctl --user enable aria2.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;过去用户进程在用户登出时会被杀死，现在 Arch 已经修改了默认编译参数，所以不需要额外的设置。详见  &lt;a href=&quot;https://wiki.archlinux.org/index.php/Systemd/User&quot;&gt;Arch Wiki Systemd/User&lt;/a&gt; 的 &lt;a href=&quot;https://wiki.archlinux.org/index.php/Systemd/User#Kill_user_processes_on_logout&quot;&gt;Kill user processes on logout&lt;/a&gt; 部分。&lt;/p&gt;

&lt;h2 id=&quot;4防火墙配置&quot;&gt;（4）防火墙配置&lt;/h2&gt;

&lt;p&gt;打开 6800 端口&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;sudo vim /etc/iptables/iptables.rules&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;添加&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;-A INPUT -p tcp -m tcp --dport 6800 -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;使之生效&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;sudo iptables-restore &amp;lt; /etc/iptables/iptables.rules&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;最后打开 Yaaw（&lt;a href=&quot;https://yaaw.fiepi.com&quot;&gt;yaaw.fiepi.com&lt;/a&gt;） 前端，填入配置：&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;https://token:xxxxxx@aria2.fiepi.com:6800/jsonrpc
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>fiepi</name></author><category term="archlinux" /><category term="archlinux" /><category term="aria2" /><category term="https" /><category term="letsencrypt" /><summary type="html">Aria2 是一个轻量的多协议、多线程下载器。这里记录一下安装配置过程。</summary></entry></feed>