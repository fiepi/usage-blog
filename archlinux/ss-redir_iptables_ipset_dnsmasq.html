<!DOCTYPE html>



<html lang="zh-CN">
<head>
  
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="先輩最低です">
<meta name="keywords" content="Linux, Arch Linux, Android, and Blog">
<meta name="author" content="ss-redir+iptables+ipset+dnsmasq 配置记录 | 玛修·基列莱特">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#e91e63">
<meta name="google" content="notranslate">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ss-redir+iptables+ipset+dnsmasq 配置记录 | 玛修·基列莱特">
<meta name="twitter:description" content="先輩最低です">
<meta name="twitter:image" content="https://blog.fiepi.com/assets/img/logo.png">
<meta property="og:type" content="blog">
<meta property="og:url" content="https://blog.fiepi.com">
<meta property="og:title" content="ss-redir+iptables+ipset+dnsmasq 配置记录 | 玛修·基列莱特">
<meta property="og:description" content="先輩最低です">
<meta property="og:image" content="https://blog.fiepi.com/assets/img/logo.png">
<title>ss-redir+iptables+ipset+dnsmasq 配置记录 | 玛修·基列莱特</title>
<link rel="canonical" href="https://blog.fiepi.com/archlinux/ss-redir_iptables_ipset_dnsmasq.html">
<link type="application/xml" rel="sitemap" href="https://blog.fiepi.com/sitemap.xml" title="ss-redir+iptables+ipset+dnsmasq 配置记录 | 玛修·基列莱特"/>
<link type="application/atom+xml" rel="alternate" href="https://blog.fiepi.com/atom.xml" title="玛修·基列莱特" />

  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Fira+Mono|Material+Icons|Quicksand">
<link type="text/css" rel="stylesheet" href="https://blog.fiepi.com/assets/css/font-awesome.min.css">
<link type="text/css" rel="stylesheet" href="https://blog.fiepi.com/assets/css/materialize.css" media="screen">
<link type="text/css" rel="stylesheet" href="https://blog.fiepi.com/assets/css/prism.css">
<link type="text/css" rel="stylesheet" href="https://blog.fiepi.com/assets/css/skeleton.css">
<link type="text/css" rel="stylesheet" href="http://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-kr.css">
<link type="text/css" rel="stylesheet" href="https://blog.fiepi.com/assets/css/style.css">

  <link rel="stylesheet" href="/assets/css/syntax.css">
</head>

<body>
  <style type="text/css">
      nav { background-color: #e91e63; color: #fff ; }
      nav a { color: #fff; }
      nav ul a { color: #fff; }
      nav .brand-logo { color: #fff; }
    </style>
  <header>
    <div class="navbar-fixed">
<nav>
    <div class="nav-wrapper">
      <a class="brand-logo logo-font center" href="https://blog.fiepi.com" style="max-width: 60%; max-height: 56px; overflow: hidden;">玛修·基列莱特</a>
      <a class="button-collapse" data-activates="mobile-nav" href="#"><i class="material-icons">menu</i></a>
    </nav>
</div>

<ul class="side-nav" id="mobile-nav">
    <li>
      <div class="user-view">
       <div class="background pink base"></div>
       <img class="circle materialboxed" data-caption="Mash Kyrielight" src="https://github.com/fiepi.png" alt="Avatar">
       <span class="white-text name">Mash Kyrielight</span>
       
       <a href="mailto:fiepi.dev@gamil.com"><span class="white-text email">fiepi.dev@gamil.com</span></a>
       
     </div>
    </li>
    <form>
        <div class="input-field">
          <input id="search" type="search" required>
          <label class="label-icon" for="search"><i class="material-icons">search</i></label>
          <i class="material-icons">close</i>
        </div>
    </form>
   <li><a class="logo-font" href="https://blog.fiepi.com">首页</a></li>
   <li><a class="logo-font" href="https://blog.fiepi.com/categories.html">分类</a></li>
   <li><a class="logo-font" href="https://blog.fiepi.com/archive.html">归档</a></li>
   <li><a class="logo-font" href="https://blog.fiepi.com/tags.html">页面和标签</a></li>
   <div class="divider"></div>
   <li><a class="logo-font" href="https://blog.fiepi.com/atom.xml">RSS 订阅</a></li>
   <li><a class="logo-font" href="https://www.fiepi.com">主站</a></li>
   <li><a class="logo-font" href="https://blog.fiepi.com/about.html">关于</a></li>
</ul>

<a href="#" data-activates="slide-out" class="button-collapse"><i class="mdi-navigation-menu"></i></a>
<ul id="slide-out" class="side-nav fixed">
    <li>
       <div class="user-view">
          <div class="background pink base"></div>
          <img class="circle materialboxed" data-caption="Mash Kyrielight" src="https://github.com/fiepi.png" alt="Avatar">
          <span class="white-text name">Mash Kyrielight</span>
           
           <a href="mailto:fiepi.dev@gamil.com"><span class="white-text email">fiepi.dev@gamil.com</span></a>
           
       </div>
    </li>
    <form>
      <div class="input-field">
        <input id="search" type="search" required>
        <label class="label-icon" for="search"><i class="material-icons">search</i></label>
        <i class="material-icons">close</i>
      </div>
  </form>
    <li><a class="logo-font" href="https://blog.fiepi.com">首页</a></li>
    <li><a class="logo-font" href="https://blog.fiepi.com/categories.html">分类</a></li>
    <li><a class="logo-font" href="https://blog.fiepi.com/archive.html">归档</a></li>
    <li><a class="logo-font" href="https://blog.fiepi.com/tags.html">页面和标签</a></li>
    <div class="divider"></div>
    <li><a class="logo-font" href="https://blog.fiepi.com/atom.xml">RSS 订阅</a></li>
    <li><a class="logo-font" href="https://www.fiepi.com">主站</a></li>
    <li><a class="logo-font" href="https://blog.fiepi.com/about.html">关于</a></li>
</ul>

  </header>
  <main>
    <section>
      

<div class="container">
  <div class="section">
    <div class="row">
      <div class="col s12">
        <article>
          <div class="card">
            
            <div class="card-image">
              <img class="materialboxed" data-caption="© Atha（アサ）" src="https://i.loli.net/2017/11/05/59ff0dc66ede7.jpg">
              <span class="card-title" style="background-color: rgba(0,0,0,.3); width: 100%;">ss-redir+iptables+ipset+dnsmasq 配置记录</span>
            </div>
            
            <div class="card-content">
              
              <p style="font-weight: 600; margin-bottom: 10px;"><time datetime="">2017-11-05</time> | <a href="https://blog.fiepi.com/archlinux/ss-redir_iptables_ipset_dnsmasq.html#disqus_thread" data-disqus-identifier="/archlinux/ss-redir_iptables_ipset_dnsmasq">评论</a></p>
              <div id="post-content">
                <p>记录 ss-redir 透明代理配置过程。
<!-- more --></p>

<h2 id="相关软件包">相关软件包</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dnsmasq ipset shadowsocks-libev
</code></pre></div></div>

<h2 id="ss-redir-配置">ss-redir 配置</h2>

<p>创建配置文件</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vim /etc/shadowsocks/ss-redir.json
{
	"server": "[server_ip]",
	"server_port": [server_port],
	"local_port": 10800,
	"local_address": "127.0.0.1",
	"password": "password",
	"timeout": 300,
	"method": "aes-256-gcm"
}
</code></pre></div></div>
<p>systemd 守护进程</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vim /etc/systemd/system/ss-redir.service

[Unit]
Description=Shadowsocks-Libev Client Service Redir Mode
After=network.target

[Service]
Type=simple
User=nobody
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
ExecStart=/usr/bin/ss-redir -c /etc/shadowsocks/ss-redir.json -u

[Install]
WantedBy=multi-user.target

</code></pre></div></div>
<p>保持自启动</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo systemctl start ss-redir.service
sudo systemctl enable ss-redir.service
</code></pre></div></div>

<h2 id="iptables--ipset-实现-chnroute-分流">iptables + ipset 实现 chnroute 分流</h2>

<p>获取中国 IP</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># wget -O- 'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest' | awk -F\| '/CN\|ipv4/ { printf("%s/%d\n", $4, 32-log($5)/log(2)) }' &gt; /etc/chnroute.txt

</code></pre></div></div>
<p>停用默认防火墙自启动服务</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo systemctl disable iptables.service
</code></pre></div></div>
<p>新建启动脚本</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vim /etc/iptables/ss-up.sh

#!/bin/bash

ipset -N chnroute hash:net maxelem 65536

for ip in $(cat '/etc/chnroute.txt'); do
  ipset add chnroute $ip
done

iptables -t nat -N SHADOWSOCKS

# 直连服务器 IP
iptables -t nat -A SHADOWSOCKS -d [server_ip]/24 -j RETURN

# 允许连接保留地址
iptables -t nat -A SHADOWSOCKS -d 0.0.0.0/8 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 10.0.0.0/8 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 127.0.0.0/8 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 169.254.0.0/16 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 172.16.0.0/12 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 192.168.0.0/16 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 224.0.0.0/4 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 240.0.0.0/4 -j RETURN

# 直连中国 IP
iptables -t nat -A SHADOWSOCKS -p tcp -m set --match-set chnroute dst -j RETURN
iptables -t nat -A SHADOWSOCKS -p icmp -m set --match-set chnroute dst -j RETURN

# 重定向到 ss-redir 端口
iptables -t nat -A SHADOWSOCKS -p tcp -j REDIRECT --to-port 10800
iptables -t nat -A SHADOWSOCKS -p udp -j REDIRECT --to-port 10800
iptables -t nat -A OUTPUT -p tcp -j SHADOWSOCKS
</code></pre></div></div>
<p>测试执行情况</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo chmod +x /etc/iptables/ss-up.sh
sudo sh /etc/iptables/ss-up.sh
</code></pre></div></div>
<p>停止脚本</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vim /etc/iptables/ss-down.sh
sudo chmod +x /etc/iptables/ss-down.sh

#!/bin/bash
iptables -t nat -D OUTPUT -p icmp -j SHADOWSOCKS
iptables -t nat -D OUTPUT -p tcp -j SHADOWSOCKS
iptables -t nat -F SHADOWSOCKS
iptables -t nat -X SHADOWSOCKS
ipset destroy chnroute
</code></pre></div></div>

<p>添加自启动
复制修改原 iptables 的 systemd 配置</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo cp /usr/lib/systemd/system/iptables.service /etc/systemd/system/iptables-proxy.service
</code></pre></div></div>
<p>根据情况修改，参考如下</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vim /etc/systemd/system/iptables-proxy.service

[Unit]
Description=Packet Filtering Framework and Shadowsocks-chnroute
Before=network-pre.target
Wants=network-pre.target

[Service]
Type=oneshot
ExecStart=/etc/iptables/ss-up.sh
ExecStop=/etc/iptables/ss-down.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
</code></pre></div></div>

<p>检查并添加自启动</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo systemctl daemon-reload
sudo systemctl start iptables-proxy.service
sudo systemctl status iptables-proxy.service
sudo systemctl enable iptables-proxy.service
</code></pre></div></div>

<h2 id="dnsmasq-的配置">dnsmasq 的配置</h2>
<p>Dnsmasq 提供 DNS 缓存和 DHCP 服务功能，通过缓存 DNS 请求来提高对访问过的网址的连接速度。</p>

<p>去掉 这几行的配置</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vim /etc/dnsmasq.conf

resolv-file=/etc/resolv.dnsmasq.conf
listen-address=127.0.0.1
</code></pre></div></div>
<p>修改 Dnsmasq DNS</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vim /etc/resolv.dnsmasq.conf 

nameserver 8.8.8.8
nameserver 8.8.4.4
</code></pre></div></div>
<p>修改系统 DNS</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo vim /etc/resolv.conf
nameserver 127.0.0.1
</code></pre></div></div>
<p>防止被修改</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo chattr +i /etc/resolv.conf
</code></pre></div></div>
<p>更多细节请浏览 <a href="https://wiki.archlinux.org/index.php/dnsmasq"> Dnsmasq - Arch Wiki</a></p>

<p>启动 Dnsmasq</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo systemctl start dnsmasq.service
sudo systemctl status dnsmasq.service
sudo systemctl enable dnsmasq.service
</code></pre></div></div>

              </div>
              
              <div class="divider" style="margin: 16px 0;"></div>
              
                <div class="chip">ss-redir</div>
              
                <div class="chip">iptables</div>
              
                <div class="chip">archlinux</div>
              
                <div class="chip">ipset</div>
              
                <div class="chip">dnsmasq</div>
              
            </div>
          </div>
        </article>
      </div>
      
      <div class="col s12">
        <article>
          <div class="card">
            <div class="card-content">
              <span class="card-title">评论</span>
              <div id="disqus_thread"></div>

<script>
  /**
   *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
   *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
   */
  var disqus_config = function () {
    this.page.url = "https://blog.fiepi.com/archlinux/ss-redir_iptables_ipset_dnsmasq.html";
    this.page.identifier = "/archlinux/ss-redir_iptables_ipset_dnsmasq";
  };
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://fiepi.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

            </div>
          </div>
        </article>
      </div>
      
      <div class="col s12">
        
        
        <div class="right">
          <span style="color: rgba(0,0,0,.87); margin-right: 8px;">上一篇</span>
          <a class="btn-floating waves-effect waves-light white" href="https://blog.fiepi.com/archlinux/aria2_config.html"><i class="material-icons" style="color: rgba(0,0,0,.87);">arrow_forward</i></a>
        </div>
        
      </div>
    </div>
  </div>
</div>


<script id="dsq-count-scr" src="//fiepi.disqus.com/count.js" async></script>


    </section>
  </main>
  <footer class="page-footer">
    <div class="center" style="margin-top: 16px;">
  <table>
    <tr>
      <div align="center">
        <span style="font-size: 12px; font-weight: 400; min-height: 31px;">
          <a style="color:lightgray">玛修·基列莱特 由 </a>
          <a style="color:white" href="https://jekyllrb.com/">Jekyll </a>
          <a style="color:lightgray">驱动 | 主题 - </a>
          <a style="color:white" href="https://github.com/Astro36/Materialize-Jekyll">Materialize-Jekyll</a>         
          <br>
          <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/deed.zh"><img src="https://licensebuttons.net/l/by-sa/4.0/80x15.png" alt="CC BY-SA"></a>
          <a style="color:lightgray">若无特殊声明，本站以</a>
          <a style="color:white" rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh">知识共享 署名-相同方式共享 4.0 国际 许可协议</a>
          <a style="color:lightgray">授权这里的文字内容。</a>
        </span>
      </div>
    </tr>
  </table>
</div>
<div class="footer-copyright">
  <div class="container">
    © 2017 Mash Kyrielight. All rights reserved.
    <div class="right">
      <span class="white-text" style="font-weight: 400; margin-right: 5px;">View on</span><a class="fa fa-github fa-lg white-text" href="https://github.com/fiepi"></a>
    </div>
  </div>
</div>

  </footer>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="https://blog.fiepi.com/assets/js/materialize.min.js"></script>
<script type="text/javascript" src="https://blog.fiepi.com/assets/js/prism.min.js"></script>
<script type="text/javascript">
  var now = new Date('2017-11-06 00:37:46 +0800').getTime();
  $(document).ready(function () {
    $('.button-collapse').sideNav();
    $('.collapsible').collapsible();
    $('.dropdown-button').dropdown();
    $('.materialboxed').materialbox();
    $('.parallax').parallax();
    $('time').each(function () {
      if (now - (new Date($(this).attr('datetime')).getTime()) < 311040000){
        $(this).append('<span class="new badge"></span>');
      }
    });
    var url = window.location.href;
    if (url.search('/') >= 0 || url.search('/archive') >= 0 || url.search('/categories') >= 0 || url.search('/tags') >= 0 || url.search('/2017/') >= 0) {
      $('#nav-blog').collapsible('open', 0);
    }
  });
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-98638990-2','auto');ga('send','pageview');
</script>


</body>
</html>
